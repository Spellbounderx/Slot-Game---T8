using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class GameManager : MonoBehaviour
{
    [Header("Board Settings")]
    [SerializeField] private int boardHeight = 3;
    [SerializeField] private int boardWidth = 3;

    [Header("Slot Icons")]
    [SerializeField] private GameObject[] gamePieces; // prefabs with SymbolPrefab

    [Header("UI Elements")]
    [SerializeField] private Button spinButton;
    [SerializeField] private TMP_Text balanceText;
    [SerializeField] private TMP_Text betText;
    [SerializeField] private TMP_Text lastWinText;
    [SerializeField] private TMP_InputField betInput;

    [Header("Bankroll Settings")]
    [SerializeField] private int startingBalance = 1000;

    [Header("Animation Settings")]
    [SerializeField] private float spinTime = 3.0f;
    [SerializeField] private int scrollLoops = 5;

    [Header("Audio Clips (drag audio files here)")]
    [SerializeField] private AudioClip startClip;         // when player presses spin
    [SerializeField] private AudioClip spinClip;          // plays when spin starts
    [SerializeField] private AudioClip stopClip;          // plays when reels stop
    [SerializeField] private AudioClip jackpotClip;       // plays only on win
    [SerializeField] private AudioClip outOfCreditsClip;  // plays when bet > balance
    [SerializeField] private AudioClip bgmClip;           // background music

    [Header("Audio Sources (assign or script will create them)")]
    [SerializeField] private AudioSource sfxSource;       // single SFX source for start/spin/stop/outOfCredits
    [SerializeField] private AudioSource jackpotSource;   // dedicated source for jackpot effect
    [SerializeField] private AudioSource bgmSource;       // looping background music

    [Header("Volume (0..1)")]
    [Range(0f, 1f)] [SerializeField] private float sfxVolume = 1f;
    [Range(0f, 1f)] [SerializeField] private float jackpotVolume = 1f;
    [Range(0f, 1f)] [SerializeField] private float bgmVolume = 0.25f;

    // runtime state
    private int balance;
    private int betAmount = 50;
    private int lastWin;
    private bool isSpinning = false;

    private GameObject _board;
    private GameObject[,] _gameBoard;
    private Transform[,] _gridSlots;
    private Vector3 _offset = new Vector3(0, 0, -1);
    private List<GameObject> _matchLines = new List<GameObject>();

    void Awake()
    {
        // Ensure button listener is single
        if (spinButton != null)
        {
            spinButton.onClick.RemoveAllListeners();
            spinButton.onClick.AddListener(OnSpinButtonClicked);
        }

        // Input field commit listener
        if (betInput != null)
        {
            betInput.onEndEdit.RemoveAllListeners();
            betInput.onEndEdit.AddListener((s) => UpdateBetFromInput());
        }

        // Ensure AudioSources exist â€” create if not assigned
        EnsureAudioSources();

        // Setup and start BGM (do not play jackpot or other SFX here)
        if (bgmSource != null && bgmClip != null)
        {
            bgmSource.clip = bgmClip;
            bgmSource.loop = true;
            bgmSource.volume = bgmVolume;
            bgmSource.playOnAwake = false;
            bgmSource.Play();
        }
    }

    void Start()
    {
        _board = GameObject.Find("GameBoard");
        if (_board == null)
        {
            Debug.LogError("GameBoard object not found! Make sure there is a GameObject named exactly 'GameBoard' with slot children.");
            return;
        }

        // allocate arrays
        _gameBoard = new GameObject[boardHeight, boardWidth];
        _gridSlots = new Transform[boardHeight, boardWidth];

        // cache slots
        bool missingSlot = false;
        for (int i = 0; i < boardHeight; i++)
        {
            for (int j = 0; j < boardWidth; j++)
            {
                string slotName = $"{i},{j}";
                Transform t = _board.transform.Find(slotName);
                _gridSlots[i, j] = t;
                if (t == null)
                {
                    Debug.LogError($"Slot {slotName} not found under GameBoard. Create child GameObjects named '0,0'..'2,2'.");
                    missingSlot = true;
                }
            }
        }
        if (missingSlot) return;

        // initial values
        balance = startingBalance;
        lastWin = 0;

        // update UI and spawn initial board (no jackpot SFX here)
        UpdateBetFromInput(); // reads betInput if present (does not clamp to balance here)
        UpdateUI();
        InitializeBoard();
        UpdateSpinButton();
    }

    // Ensure audio sources exist so inspector assignment optional
    private void EnsureAudioSources()
    {
        if (sfxSource == null)
        {
            GameObject sfxObj = new GameObject("SFX_Source");
            sfxObj.transform.SetParent(transform);
            sfxSource = sfxObj.AddComponent<AudioSource>();
            sfxSource.playOnAwake = false;
            sfxSource.loop = false;
        }
        if (jackpotSource == null)
        {
            GameObject jObj = new GameObject("Jackpot_Source");
            jObj.transform.SetParent(transform);
            jackpotSource = jObj.AddComponent<AudioSource>();
            jackpotSource.playOnAwake = false;
            jackpotSource.loop = false;
        }
        if (bgmSource == null)
        {
            GameObject bObj = new GameObject("BGM_Source");
            bObj.transform.SetParent(transform);
            bgmSource = bObj.AddComponent<AudioSource>();
            bgmSource.playOnAwake = false;
            bgmSource.loop = true;
        }

        // Set volumes from inspector values
        sfxSource.volume = sfxVolume;
        jackpotSource.volume = jackpotVolume;
        bgmSource.volume = bgmVolume;
    }

    // Called when player clicks Spin
    private void OnSpinButtonClicked()
    {
        UpdateBetFromInput();

        // block if already spinning
        if (isSpinning) return;

        // If bet is greater than balance, reject and play out-of-credit
        if (betAmount > balance)
        {
            if (outOfCreditsClip != null)
                sfxSource.PlayOneShot(outOfCreditsClip, sfxVolume);
            Debug.Log("Not enough credits to place that bet. Spin cancelled.");
            return;
        }

        // Play start (click) sound
        if (startClip != null)
            sfxSource.PlayOneShot(startClip, sfxVolume);

        // begin spin coroutine
        StartCoroutine(SpinRoutine());
    }

    // Read bet input (does not clamp to balance; we validate before spin)
    private void UpdateBetFromInput()
    {
        if (betInput == null) return;

        int value;
        if (int.TryParse(betInput.text, out value))
        {
            betAmount = Mathf.Max(1, value);
        }
        else
        {
            // keep current betAmount if input invalid; set input text to it for clarity
            betInput.text = betAmount.ToString();
        }

        if (betText != null) betText.text = "Bet: " + betAmount;
        UpdateSpinButton();
    }

    // spawn initial symbols (no SFX)
    private void InitializeBoard()
    {
        for (int r = 0; r < boardHeight; r++)
            for (int c = 0; c < boardWidth; c++)
                SpawnSymbol(r, c, immediate: true);
    }

    // main spin coroutine
    private IEnumerator SpinRoutine()
    {
        isSpinning = true;

        // Deduct bet (we already checked betAmount <= balance in OnSpinButtonClicked)
        balance -= betAmount;
        UpdateUI();
        UpdateSpinButton();
        ClearMatchLines();

        // Play spin sound once at start (one-shot)
        if (spinClip != null)
            sfxSource.PlayOneShot(spinClip, sfxVolume);

        // Replace symbols a few times to simulate spinning (no position shifting)
        for (int loop = 0; loop < scrollLoops; loop++)
        {
            for (int r = 0; r < boardHeight; r++)
            {
                for (int c = 0; c < boardWidth; c++)
                {
                    SpawnSymbol(r, c);
                }
            }
            yield return new WaitForSeconds(spinTime / scrollLoops);
        }

        // Play stop sound
        if (stopClip != null)
            sfxSource.PlayOneShot(stopClip, sfxVolume);

        // Check for payout in center row
        int payout = CheckCenterRow();
        if (payout > 0)
        {
            int winAmount = payout * betAmount;
            lastWin = winAmount;
            balance += winAmount;

            // Play jackpot independently and only now
            if (jackpotClip != null)
                jackpotSource.PlayOneShot(jackpotClip, jackpotVolume);
        }

        UpdateUI();

        isSpinning = false;
        UpdateSpinButton();
    }

    // instantiate prefab at slot position
    private void SpawnSymbol(int row, int col, bool immediate = false)
    {
        if (_gridSlots == null || gamePieces == null || gamePieces.Length == 0) return;
        if (_gridSlots[row, col] == null) return;

        // destroy previous
        if (_gameBoard[row, col] != null)
        {
            Destroy(_gameBoard[row, col]);
            _gameBoard[row, col] = null;
        }

        // spawn random piece
        GameObject prefab = gamePieces[Random.Range(0, gamePieces.Length)];
        if (prefab == null) return;

        Vector3 pos = _gridSlots[row, col].position + _offset;
        GameObject obj = Instantiate(prefab, pos, Quaternion.identity, _gridSlots[row, col]);
        obj.name = prefab.name;
        _gameBoard[row, col] = obj;
    }

    // center row only (row index 1)
    private int CheckCenterRow()
    {
        int row = 1;
        if (_gameBoard[row, 0] == null || _gameBoard[row, 1] == null || _gameBoard[row, 2] == null)
            return 0;

        string a = _gameBoard[row, 0].name;
        string b = _gameBoard[row, 1].name;
        string c = _gameBoard[row, 2].name;

        if (a == b && b == c)
        {
            DrawLine(_gameBoard[row, 0].transform.position + _offset,
                     _gameBoard[row, 2].transform.position + _offset);

            SymbolPrefab sp = _gameBoard[row, 0].GetComponent<SymbolPrefab>();
            return sp != null && sp.symbolData != null ? sp.symbolData.payout : 2;
        }
        return 0;
    }

    private void DrawLine(Vector3 start, Vector3 end)
    {
        GameObject line = new GameObject("WinLine");
        LineRenderer lr = line.AddComponent<LineRenderer>();
        lr.positionCount = 2;
        lr.SetPosition(0, start);
        lr.SetPosition(1, end);
        lr.startWidth = lr.endWidth = 0.1f;
        lr.material = new Material(Shader.Find("Sprites/Default"));
        lr.startColor = lr.endColor = Color.yellow;
        _matchLines.Add(line);
    }

    private void ClearMatchLines()
    {
        foreach (var l in _matchLines)
            if (l != null) Destroy(l);
        _matchLines.Clear();
    }

    private void UpdateUI()
    {
        if (balanceText != null) balanceText.text = "Balance: " + balance;
        if (betText != null) betText.text = "Bet: " + betAmount;
        if (lastWinText != null) lastWinText.text = "Last Win: " + lastWin;
    }

    private void UpdateSpinButton()
    {
        if (spinButton != null)
            spinButton.interactable = (balance >= betAmount) && !isSpinning;
    }

    // ===== Public volume controls (wire these to UI sliders if you want) =====
    public void SetSfxVolume(float v)
    {
        sfxVolume = Mathf.Clamp01(v);
        if (sfxSource != null) sfxSource.volume = sfxVolume;
    }

    public void SetJackpotVolume(float v)
    {
        jackpotVolume = Mathf.Clamp01(v);
        if (jackpotSource != null) jackpotSource.volume = jackpotVolume;
    }

    public void SetBgmVolume(float v)
    {
        bgmVolume = Mathf.Clamp01(v);
        if (bgmSource != null) bgmSource.volume = bgmVolume;
    }

    // Optional: helper to directly play jackpot (safe public API)
    public void PlayJackpot()
    {
        if (jackpotClip != null && jackpotSource != null)
            jackpotSource.PlayOneShot(jackpotClip, jackpotVolume);
    }
}
